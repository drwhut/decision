

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Code Generation &mdash; Decision 0.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimisation" href="optimisation.html" />
    <link rel="prev" title="Error Reporting" href="error_reporting.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Decision
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../the_language/index.html">The Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../common_data_structures/index.html">Common Data Structures</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Stages of Compilation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="lexical_analysis.html">Lexical Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax_analysis.html">Syntax Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="semantic_analysis.html">Semantic Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="error_reporting.html">Error Reporting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Code Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#definition-nodes">Definition Nodes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#subroutines">Subroutines</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#execution-nodes">Execution Nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-execution-nodes">Non-Execution Nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calling-convention">Calling Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="#structures">Structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sockets">Sockets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linking-functions">Linking Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generation-functions">Generation Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">Conclusion</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#output">Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#object-sections">Object Sections</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="optimisation.html">Optimisation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../linking/index.html">Linking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../the_virtual_machine/index.html">The Virtual Machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../the_c_api/index.html">The C API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Decision</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">The Stages of Compilation</a> &raquo;</li>
        
      <li>Code Generation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/the_stages_of_compilation/code_generation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="code-generation">
<span id="id1"></span><h1>Code Generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h1>
<p>Code Generation is perfomed in <code class="docutils literal notranslate"><span class="pre">dcodegen.c</span></code> and <code class="docutils literal notranslate"><span class="pre">dcodegen.h</span></code>.</p>
<p>After we’ve made a model of the sheet in memory, and after we’ve checked that
everything the user has made is syntactically and semantically correct,
we now need to generate the <strong>bytecode</strong> for <a class="reference internal" href="../the_virtual_machine/index.html#the-virtual-machine"><span class="std std-ref">The Virtual Machine</span></a> to
run.</p>
<p>So far, the difference between <em>execution</em> and <em>non-execution</em> nodes has
only been that execution nodes have execution sockets - the main difference
will be explained in this section.</p>
<div class="section" id="definition-nodes">
<h2>Definition Nodes<a class="headerlink" href="#definition-nodes" title="Permalink to this headline">¶</a></h2>
<p>For definition nodes, the first thing we do is generate a return instruction
before generating anything else. This essentially acts as a “bookmark” for
the function in the bytecode, which the linker can later point to.</p>
<div class="section" id="subroutines">
<h3>Subroutines<a class="headerlink" href="#subroutines" title="Permalink to this headline">¶</a></h3>
<p>For subroutines like <code class="docutils literal notranslate"><span class="pre">Start</span></code>, the code generator will recurse through the
execution wires and generate the bytecode for each execution node in sequence.</p>
</div>
<div class="section" id="functions">
<h3>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h3>
<p>For functions, the code generator will try and find the <code class="docutils literal notranslate"><span class="pre">Return</span></code> node for
the function, and recurse backwards to generate the bytecode to calculate
the return values. The reason for this is because we don’t have an order of
execution as we do for execution nodes.</p>
</div>
</div>
<div class="section" id="execution-nodes">
<h2>Execution Nodes<a class="headerlink" href="#execution-nodes" title="Permalink to this headline">¶</a></h2>
<p>When an execution node is reached, it will first generate the bytecode to get
the inputs. If the inputs are literals, then this is trivial. But if there
is a connection to the input’s socket, then we need to follow the connection
and recursively generate the bytecode for the node that starts the connection.</p>
<p>Secondly, bytecode is generated depending on the node itself, using the
inputs. If the node is a core function, then we can directly insert the
bytecode in. Otherwise, we make use of the calling abilities of
<a class="reference internal" href="../the_virtual_machine/index.html#the-virtual-machine"><span class="std std-ref">The Virtual Machine</span></a>.</p>
<p>Lastly, it will check to see if the last output execution socket has a
connection. If it does, then there is something more to do after this node
is finished. We then recursively generate the bytecode for the next execution
node and add it on to the bytecode we’ve already generated. Otherwise, we may
want to put a return instruction at the end of the sequence to say that we
are done. In some cases, however, this is not needed, like inside <code class="docutils literal notranslate"><span class="pre">For</span></code>
loops.</p>
<p>When getting output from an execution node, the generator will copy the output
onto the top of the stack in order to preserve the original value.</p>
</div>
<div class="section" id="non-execution-nodes">
<h2>Non-Execution Nodes<a class="headerlink" href="#non-execution-nodes" title="Permalink to this headline">¶</a></h2>
<p>When a non-execution node is reached, it will first generate the bytecode to
get the inputs, like with execution nodes.</p>
<p>Next, bytecode is generated depending on the node itself, using the inputs.
This process is almost exactly the same as with execution nodes, including
if the function is not a core function.</p>
<p>However, unlike execution nodes, it does <em>not</em> generate any more bytecode past
the current node. This is because non-execution nodes are purely meant to be
called upon from execution nodes.</p>
<p>When getting output from a non-execution node, it will be used by the node
getting the input. This ensures that if values change over time, then the
calculations will produce different results over time as well. Non-execution
nodes are purely meant to just manipulate
the inputs to execution nodes.</p>
</div>
<div class="section" id="calling-convention">
<span id="id2"></span><h2>Calling Convention<a class="headerlink" href="#calling-convention" title="Permalink to this headline">¶</a></h2>
<p>If we see a node with a name that isn’t a core function, it needs to be
<em>called</em>. How we call functions is important and should be as efficient as
possible since there could be lots of calls during execution, especially
if the call is inside a loop.</p>
<p>Arguments and return values are easy - arguments are pushed onto the stack in
order before the call, and return values are pushed onto the stack in reverse
order before returning.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The calling and returning instructions in <a class="reference internal" href="../the_virtual_machine/index.html#the-virtual-machine"><span class="std std-ref">The Virtual Machine</span></a> have a
byte immediate operand for how many arguments or return values there are,
meaning you can only have at most up to 256 arguments and 256 returns.</p>
</div>
</div>
<div class="section" id="structures">
<h2>Structures<a class="headerlink" href="#structures" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">BCode</span></code></dt><dd><p>Essentially a list of <code class="docutils literal notranslate"><span class="pre">char</span></code>. Its purpose is to store bytecode and be
a convenient way to build up the bytecode. It also stores alongside the
code a list of instruction indexes and what they should be linked to,
as well as a list of indexes to say where functions start pushing
return values onto the stack.</p>
</dd>
</dl>
<p>There are 3 convenient functions for <code class="docutils literal notranslate"><span class="pre">BCode</span></code>:</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_malloc_bytecode</code><span class="sig-paren">(</span>size_t <em>size</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Create a malloc’d BCode object, with a set number of bytes. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>The BCode object with malloc’d elements.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">size</span></code>: The number of bytes. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Automatically allocates memory to store bytecode for you.</p>
<p>Likewise, there is a function to free the memory:</p>
<dl class="function">
<dt>
void <code class="sig-name descname">d_free_bytecode</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> *<em>bcode</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Free malloc’d elements of bytecode. </p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bcode</span></code>: The bytecode to free. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Arguably the most useful function however is:</p>
<dl class="function">
<dt>
void <code class="sig-name descname">d_concat_bytecode</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> *<em>base</em>, <a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> *<em>after</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Append bytecode to the end of another set of bytecode. </p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">base</span></code>: The bytecode to be added to. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">after</span></code>: The bytecode to append. Not changed. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Concatenates <code class="docutils literal notranslate"><span class="pre">after</span></code> onto the end of <code class="docutils literal notranslate"><span class="pre">base</span></code>, which makes building up the
bytecode simple.</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">BuildContext</span></code></dt><dd><p>Contains useful information used by the code generator to help make the
most efficient bytecode possible. Only one instance is made at the
beginning of Bytecode Generation, and it is passed around by reference
throughout.</p>
<p>It also stores a section of memory for data like variables and string
literals, which will be stored in the sheet, and also keeps track of
links to those items.</p>
<p>One thing we want to guarantee when creating the bytecode is that
<a class="reference internal" href="../the_virtual_machine/index.html#the-virtual-machine"><span class="std std-ref">The Virtual Machine</span></a> stack is as small as possible throughout the
execution of the program. This is done by keeping track, at any one time,
of what the index of the top of the stack is.</p>
</dd>
</dl>
</div>
<div class="section" id="sockets">
<h2>Sockets<a class="headerlink" href="#sockets" title="Permalink to this headline">¶</a></h2>
<p>One important thing to note is how a node knows which input corresponds to
which element in the stack.</p>
<p>Inside the <code class="docutils literal notranslate"><span class="pre">Node</span></code> structure defined in <code class="docutils literal notranslate"><span class="pre">dgraph.h</span></code>, there is a property
called <code class="docutils literal notranslate"><span class="pre">_stackPositions</span></code>. Only Code Generation uses this property.
If the socket is connected, the socket’s entry will be set to the index of the
socket’s value in the stack at that time. If there is no connection, then an
index may or may not be assigned for the literal value, depending on if we want
to use the literal value as an immediate or not.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference internal" href="../the_virtual_machine/index.html#the-virtual-machine"><span class="std std-ref">The Virtual Machine</span></a> to see what I mean by an <em>immediate</em> value.</p>
</div>
<p>This way, indexes are passed along from socket to socket, so that the next node
knows in what index the socket’s value is in.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most of the bytecode generation functions guarantee that the output is on
the top of the stack, so usually we take advantage of this and don’t bother
to read the socket’s stack index.</p>
</div>
</div>
<div class="section" id="linking-functions">
<h2>Linking Functions<a class="headerlink" href="#linking-functions" title="Permalink to this headline">¶</a></h2>
<p>The whole process of linking is explained in <a class="reference internal" href="../linking/index.html#linking"><span class="std std-ref">Linking</span></a>, but in order for
it to work, we need to do 2 things:</p>
<ol class="arabic simple">
<li><p>We need to know what things we need to link to, like variables or
functions.</p></li>
<li><p>We need to say which instructions need to point to which link.</p></li>
</ol>
<dl class="function">
<dt>
void <code class="sig-name descname">d_add_link_to_ins</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> *<em>bcode</em>, size_t <em>insIndex</em>, <a class="reference internal" href="../reference/index.html#_CPPv48LinkMeta" title="LinkMeta">LinkMeta</a> <em>linkMeta</em>, size_t *<em>indexInList</em>, bool *<em>wasDuplicate</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Add a future link to an instruction in bytecode. </p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to store the link. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bcode</span></code>: The bytecode containing the instruction to link. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">insIndex</span></code>: The index of the instruction to edit when linking is taking place. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linkMeta</span></code>: The link metadata. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">indexInList</span></code>: Stores in the reference the index of the new metadata in the list. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wasDuplicate</span></code>: Sets the reference to true if a matching linkMeta was already found in the array, false otherwise. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function puts information into <code class="docutils literal notranslate"><span class="pre">context</span></code> to say which instruction in
<code class="docutils literal notranslate"><span class="pre">bcode</span></code> (index <code class="docutils literal notranslate"><span class="pre">insIndex</span></code>) needs to point to some link <code class="docutils literal notranslate"><span class="pre">linkMeta</span></code>. If
<code class="docutils literal notranslate"><span class="pre">linkMeta</span></code> is a duplicate of a previously linked <code class="docutils literal notranslate"><span class="pre">linkMeta</span></code>, then the
instruction points to the <em>original version</em>, and the new version is ignored.</p>
<p><code class="docutils literal notranslate"><span class="pre">indexInList</span></code> is replaced with the index of <code class="docutils literal notranslate"><span class="pre">linkMeta</span></code> in the list of
<code class="docutils literal notranslate"><span class="pre">LinkMeta</span></code> in <code class="docutils literal notranslate"><span class="pre">context</span></code>, and <code class="docutils literal notranslate"><span class="pre">wasDuplicate</span></code> is replaced with a boolean
representing if <code class="docutils literal notranslate"><span class="pre">linkMeta</span></code> was already found in <code class="docutils literal notranslate"><span class="pre">context</span></code>.</p>
<dl class="function">
<dt>
char *<code class="sig-name descname">d_allocate_from_data_section</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>size</em>, size_t *<em>index</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Allocate a number of bytes from the data section for some data. That data could be a string literal, variable, etc. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>A pointer to the start of the new allocation. Returns NULL if size is 0.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context that contains the built-up data section. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size of the allocation in bytes. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">index</span></code>: Overwrites with the index of the start of the allocation from the start of the data section. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Allocates a chunk of memory for the data section in <code class="docutils literal notranslate"><span class="pre">context</span></code>. <code class="docutils literal notranslate"><span class="pre">size</span></code> is
the size of the allocation in bytes, and <code class="docutils literal notranslate"><span class="pre">index</span></code> is replaced with the index
of the start of the allocation, which is useful when creating links. The
function returns a <em>pointer</em> to the start of the allocation, rather than the
<em>index</em>. This makes copying data into the allocation easy.</p>
<dl class="function">
<dt>
size_t <code class="sig-name descname">d_allocate_string_literal_in_data</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> *<em>linkCode</em>, size_t <em>insIndex</em>, char *<em>stringLiteral</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a string literal, allocate memory from the data section to store the literal. </p>
<p>If there is a duplicate string literal found, the links to string literal passed are pointed to the literal already stored in the data section. <strong>NOTE:</strong> If the string was a duplicate, it is freed!</p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>The index of the data section where the string literal starts.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context containing the built-up data section. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linkCode</span></code>: The bytecode to link to the string literal in the data section. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">insIndex</span></code>: The index of the LOADUI instruction to replace when linking is taking place. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stringLiteral</span></code>: The string literal to place in the data section. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Allocated memory for the data section of <code class="docutils literal notranslate"><span class="pre">context</span></code> in order to fit the
length of <code class="docutils literal notranslate"><span class="pre">stringLiteral</span></code>. This function automatically links an instruction
from <code class="docutils literal notranslate"><span class="pre">linkCode</span></code> (index <code class="docutils literal notranslate"><span class="pre">insIndex</span></code>) to the string literal’s new location.</p>
<dl class="function">
<dt>
void <code class="sig-name descname">d_allocate_variable</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../common_data_structures/index.html#_CPPv413SheetVariable" title="SheetVariable">SheetVariable</a> *<em>variable</em>, size_t <em>size</em>, size_t <em>indexInLinkMeta</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Allocate memory from the data section to store a variable. </p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context containing the built-up data section. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">variable</span></code>: The variable data. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size</span></code>: How many bytes to allocate for the variable. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">indexInLinkMeta</span></code>: The index of the variable’s LinkMeta entry in the build context. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Allocates memory for the data section of <code class="docutils literal notranslate"><span class="pre">context</span></code>, in order to fit the
content of a variable <code class="docutils literal notranslate"><span class="pre">variable</span></code>. You can specify a size, which is usually
<code class="docutils literal notranslate"><span class="pre">sizeof(dint)</span></code>, all you need to provide is the index of the variable’s entry
in the <code class="docutils literal notranslate"><span class="pre">LinkMeta</span></code> list in <code class="docutils literal notranslate"><span class="pre">context</span></code>.</p>
</div>
<div class="section" id="generation-functions">
<h2>Generation Functions<a class="headerlink" href="#generation-functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_push_literal</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../common_data_structures/index.html#_CPPv410NodeSocket" title="NodeSocket">NodeSocket</a> <em>socket</em>, bool <em>cvtFloat</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Generate bytecode to push a literal onto the stack. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to push the socket’s literal onto the stack.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to build the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">socket</span></code>: The socket of the literal to push onto the stack. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cvtFloat</span></code>: Converts the literal to a float if possible. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function takes a literal value and pushes it onto the top of the stack.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_push_variable</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a node that is the getter of a variable, generate bytecode to push the value of the variable onto the stack. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to push the variable’s value onto the stack.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to build the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The index of the node that is the getter of a variable. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function takes a variable’s value and pushes it onto the top of the stack.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_push_input</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../common_data_structures/index.html#_CPPv410NodeSocket" title="NodeSocket">NodeSocket</a> <em>socket</em>, bool <em>forceFloat</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given an input socket, generate bytecode to push the value of the input to the top of the stack. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to push the input’s value onto the stack.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to build the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">socket</span></code>: The input socket to get the value for. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forceFloat</span></code>: Force integers to be converted to floats. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function takes an input socket and pushes it’s value onto the top of the
stack. However, that is not as simple as it sounds, as it may generate the
entire bytecode nessesary to get the value.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_push_node_inputs</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em>, bool <em>order</em>, bool <em>ignoreLiterals</em>, bool <em>forceFloat</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a node, generate bytecode to push the values of the inputs to the top of the stack. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to push all input’s values onto the stack.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The index of the node whose input sockets to generate bytecode for. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">order</span></code>: If true, the inputs are pushed in order, such that the last input is at the top. If false, the inputs are pushed in reverse order, such that the first input is at the top. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ignoreLiterals</span></code>: Do not generate bytecode for non-float literal inputs. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forceFloat</span></code>: Force integers to be converted to floats. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function takes the variable inputs of a node, and pushes them onto the top
of the stack in an order of your choosing.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_operator</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em>, <a class="reference internal" href="../reference/index.html#_CPPv44DIns" title="DIns">DIns</a> <em>opcode</em>, <a class="reference internal" href="../reference/index.html#_CPPv44DIns" title="DIns">DIns</a> <em>fopcode</em>, <a class="reference internal" href="../reference/index.html#_CPPv44DIns" title="DIns">DIns</a> <em>fiopcode</em>, bool <em>forceFloat</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given an operator node, generate the bytecode for it. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to get the output of an operator.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The index of the operator node to get the result for. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opcode</span></code>: The operator instruction. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fopcode</span></code>: The float variant of the instruction. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fiopcode</span></code>: The full immediate variant of the instruction. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forceFloat</span></code>: Should the output always be a float? </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode for a generic operator (e.g. <code class="docutils literal notranslate"><span class="pre">Add</span></code>).</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_comparator</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em>, <a class="reference internal" href="../reference/index.html#_CPPv44DIns" title="DIns">DIns</a> <em>opcode</em>, <a class="reference internal" href="../reference/index.html#_CPPv44DIns" title="DIns">DIns</a> <em>fopcode</em>, fimmediate_t <em>strCmpArg</em>, bool <em>notAfter</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a comparator node, generate the bytecode for it. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to get the output of a comparator.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The index of the comparator node to get the result for. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opcode</span></code>: The comparator instruction. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fopcode</span></code>: The float variant of the instruction. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">strCmpArg</span></code>: The SYS_STRCMP argument to use to compare strings. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">notAfter</span></code>: Do we invert the answer at the end? </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode for a generic comparator (e.g. <code class="docutils literal notranslate"><span class="pre">Equal</span></code>).</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_call</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a node that calls a function or subroutine, generate the bytecode to call it. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to call the function or subroutine.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The index of the node to generate the bytecode for. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode to call a function or subroutine.
It abides to the calling convention and pushes the arguments in the correct
order.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_push_argument</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../common_data_structures/index.html#_CPPv410NodeSocket" title="NodeSocket">NodeSocket</a> <em>socket</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given an output socket that is a function/subroutine argument, generate bytecode to push the value of the argument to the top of the stack. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to push the argument.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">socket</span></code>: The output socket representing the function argument. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>If you are in a function or subroutine, and you want an argument on the top of
the stack, this is the function for that.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_return</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>returnNodeIndex</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a Return node, generate the bytecode to return from the function/subroutine with the return values. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to return from the function/subroutine.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">returnNodeIndex</span></code>: The Return node to return with. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode to return from the function or subroutine.
It abides to the calling convention and pushes the return values in reverse
order.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_nonexecution_node</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a non-execution node, generate the bytecode to get the output. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to run the nonexecution node’s function.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The index of the non-execution node. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode for a generic non-execution node.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_execution_node</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>nodeIndex</em>, bool <em>retAtEnd</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given an execution node, generate the bytecode to get the output. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>Bytecode to run the execution node’s subroutine.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodeIndex</span></code>: The execution node. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">retAtEnd</span></code>: Should the bytecode return at the end? </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode for a generic execution node.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_start</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, size_t <em>startNodeIndex</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a Start node, generate the bytecode for the sequence starting from this node. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>The bytecode generated for the Start function.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">startNodeIndex</span></code>: The Start node index. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode for the main Start function.</p>
<dl class="function">
<dt>
<a class="reference internal" href="../reference/index.html#_CPPv45BCode" title="BCode">BCode</a> <code class="sig-name descname">d_generate_function</code><span class="sig-paren">(</span><a class="reference internal" href="../reference/index.html#_CPPv412BuildContext" title="BuildContext">BuildContext</a> *<em>context</em>, <a class="reference internal" href="../common_data_structures/index.html#_CPPv413SheetFunction" title="SheetFunction">SheetFunction</a> <em>func</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given a function, generate the bytecode for it. </p>
<p><dl class="simple">
<dt><strong>Return</strong></dt><dd><p>The bytecode generated for the function.</p>
</dd>
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>: The context needed to generate the bytecode. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code>: The function to generate the bytecode for. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>This function generates the bytecode for a function or subroutine defined in
the sheet.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>In order to do all of the above, all you need is the function:</p>
<dl class="function">
<dt>
void <code class="sig-name descname">d_codegen_compile</code><span class="sig-paren">(</span><a class="reference internal" href="../common_data_structures/index.html#_CPPv45Sheet" title="Sheet">Sheet</a> *<em>sheet</em>, bool <em>debug</em><span class="sig-paren">)</span><br /></dt>
<dd><p>Given that Semantic Analysis has taken place, generate the bytecode for a given sheet. </p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sheet</span></code>: The sheet to generate the bytecode for. </p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">debug</span></code>: If true, we include debug information as well. </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<p>Which takes a sheet, generates the bytecode, and inserts it into the sheet
once it’s done.</p>
<div class="section" id="output">
<h3>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h3>
<p>By the end of compilation, if everything succeeds, then you should have a
<code class="docutils literal notranslate"><span class="pre">Sheet</span></code> with the contents of an <strong>object file</strong>. An object file is made up
of multiple sections that contain different data.</p>
<p>The functionality to save, load and dump Decision object files can be found
in <code class="docutils literal notranslate"><span class="pre">dasm.h</span></code>.</p>
</div>
<div class="section" id="object-sections">
<h3>Object Sections<a class="headerlink" href="#object-sections" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.text</span></code>: A list of instructions for <a class="reference internal" href="../the_virtual_machine/index.html#the-virtual-machine"><span class="std std-ref">The Virtual Machine</span></a> to execute.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.main</span></code>: An integer which says which instruction in <code class="docutils literal notranslate"><span class="pre">.text</span></code> should be
the one to execute first if this sheet is where we start executing. It
essentially points to the compiled <code class="docutils literal notranslate"><span class="pre">Start</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.data</span></code>: An allocated section of memory with items like variables and
string literals contained inside.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.lmeta</span></code>: Essentially a list of <code class="docutils literal notranslate"><span class="pre">ListMeta</span></code>, which contains data on what
and where something is.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.link</span></code>: A table of what instructions point to which index in the
<code class="docutils literal notranslate"><span class="pre">.lmeta</span></code> section.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.func</span></code>: Essentially a list of <code class="docutils literal notranslate"><span class="pre">SheetFunction</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.var</span></code>: Essentially a list of <code class="docutils literal notranslate"><span class="pre">SheetVariable</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.incl</span></code>: A list of paths to sheets that this sheet includes.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="optimisation.html" class="btn btn-neutral float-right" title="Optimisation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="error_reporting.html" class="btn btn-neutral float-left" title="Error Reporting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2020, Benjamin Beddows

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>